<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Auntie Can Count One | Summary</title>
  <style>
    :root {
      --desert-flower: #E98C7A;
      --blue-curacao: #58B8C7;
      --bg: #FFF9F6;
      --ink: #1F2328;
      --muted: #6B7280;
      --card: #FFF;
      --ring: #F0E6DE;
      --radius: 16px;
      --shadow: 0 12px 30px rgba(0,0,0,.06);
      --accent: var(--blue-curacao);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color: var(--ink);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(233,140,122,.18), transparent 60%),
        radial-gradient(1000px 500px at 110% 0%, rgba(88,184,199,.15), transparent 60%),
        linear-gradient(#FFFDFC, var(--bg));
      overflow-x: hidden;
    }
    .app {
      max-width: 1100px;
      margin: auto;
      padding: 20px clamp(14px,3vw,24px) 40px;
      display: grid;
      gap: 16px;
    }
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo {
      width: 42px;
      height: 42px;
      border-radius: 12px;
      background: linear-gradient(145deg, #C0EEF2, #F4F8F9);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow);
    }
    .logo svg {
      width: 28px;
      height: 28px;
      stroke: var(--ink);
      fill: none;
      stroke-width: 1.8;
    }
    h1 {
      margin: 0;
      font-size: clamp(1.1rem, 1vw + 1rem, 1.5rem);
      color: var(--brand-ink);
    }
    .sub {
      margin: 0;
      color: var(--muted);
      font-size: .95rem;
    }
    .controls {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .primary {
      background: linear-gradient(180deg, #FFE7E1 0%, #FFD9D0 100%);
      border: 1px solid #FFD2C8;
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 700;
      color: #6E362D;
      cursor: pointer;
      transition: background .2s;
    }
    .primary:hover {
      background: linear-gradient(180deg, #FFDDCE 0%, #FFCAAF 100%);
    }
    .meta {
      color: var(--muted);
      font-size: .9rem;
    }
    .dropdown {
      position: relative;
    }
    .dropdown-btn {
      background: linear-gradient(180deg, #FDF7F5 0%, #FCEFEA 100%);
      border: 1px solid var(--ring);
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 600;
      color: var(--ink);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: border-color .2s;
    }
    .dropdown-btn:hover {
      border-color: var(--accent);
    }
    .dropdown-menu {
      position: absolute;
      top: 110%;
      left: 0;
      background: var(--card);
      border: 1px solid var(--ring);
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,.08);
      min-width: 160px;
      padding: 6px 0;
      opacity: 0;
      pointer-events: none;
      transform: translateY(8px);
      transition: opacity .25s ease, transform .25s ease;
      z-index: 100;
    }
    .dropdown.open .dropdown-menu {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }
    .dropdown-item {
      padding: 10px 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--ink);
      font-size: .95rem;
      cursor: pointer;
      transition: background .15s;
    }
    .dropdown-item:hover {
      background: linear-gradient(90deg, #E8FAFC, #fff);
    }
    .dropdown-item svg {
      width: 16px;
      height: 16px;
      stroke: var(--ink);
      stroke-width: 1.6;
      fill: none;
    }
    .kpis {
      grid-column: 1 / -1;
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(12, 1fr);
    }
    .kpi {
      grid-column: span 4;
      background: var(--card);
      border: 1px solid var(--ring);
      border-radius: 14px;
      padding: 14px 16px;
      box-shadow: var(--shadow);
    }
    .kpi h3 {
      margin: 0 0 4px;
      font-size: .9rem;
      color: var(--muted);
    }
    .value {
      font-weight: 800;
      font-size: clamp(1.1rem, 1rem + 1vw, 1.6rem);
      color: var(--brand-ink);
    }
    .grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(12, 1fr);
    }
    .card {
      background: var(--card);
      border: 1px solid var(--ring);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
    }
    .section-title {
      margin: 0 0 10px;
      font-weight: 800;
      color: #6E2B20;
    }
    canvas {
      width: 100% !important;
      height: auto !important;
    }
    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #FFF7F2;
      border: 1px solid var(--ring);
      font-size: .9rem;
    }
    .dot {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }
    .table {
      width: 100%;
      border-collapse: collapse;
    }
    .table th, .table td {
      padding: 12px;
      border-bottom: 1px solid #EFE6DD;
      text-align: left;
      font-size: .95rem;
    }
    .table th {
      background: #FFF3EE;
      color: #7A5D57;
    }
    .amt {
      text-align: right;
    }
    .pct {
      color: var(--muted);
      font-size: .9rem;
      text-align: right;
    }
    .empty {
      color: var(--muted);
    }
    #popup {
      position: absolute;
      display: none;
      pointer-events: none;
      background: var(--card);
      border: 1px solid var(--ring);
      border-radius: 8px;
      padding: 6px 10px;
      box-shadow: var(--shadow);
      font-size: .85rem;
      color: var(--ink);
      z-index: 999;
    }
    #auntie-bubble {
      position: fixed;
      bottom: 16px;
      right: 16px;
      max-width: 240px;
      background: #FFF3EE;
      border: 1px solid var(--ring);
      border-radius: 16px;
      padding: 12px 14px;
      box-shadow: var(--shadow);
      font-size: .9rem;
      color: #7C3E33;
      display: none;
      animation: fadeIn .4s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @media (max-width: 960px) {
      .grid { grid-template-columns: 1fr; }
      .kpi { grid-column: 1 / -1; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo">
          <!-- New fun auntie outline SVG -->
          <svg viewBox="0 0 64 64">
            <circle cx="32" cy="32" r="28" stroke="black" fill="none"/>
            <path d="M20 38c4 6 20 6 24 0" stroke="black" />
            <path d="M24 28h16" stroke="black" />
            <circle cx="26" cy="20" r="2" fill="black"/>
            <circle cx="38" cy="20" r="2" fill="black"/>
          </svg>
        </div>
        <div>
          <h1>Auntie Can Count One ‚Äî Summary</h1>
          <p class="sub">Pastel Pantone dashboard. Donut so tiny but shiok üç©</p>
        </div>
      </div>

      <div class="controls">
        <div class="dropdown" id="rangeDrop">
          <div class="dropdown-btn" id="rangeBtn">This Week ‚ñæ</div>
          <div class="dropdown-menu" id="rangeMenu">
            <div class="dropdown-item" data-range="week">This Week</div>
            <div class="dropdown-item" data-range="month">This Month</div>
            <div class="dropdown-item" data-range="all">All Time</div>
          </div>
        </div>

        <div class="dropdown" id="exportDrop">
          <div class="dropdown-btn" id="exportBtn">Export ‚ñæ</div>
          <div class="dropdown-menu" id="exportMenu">
            <div class="dropdown-item" id="exportCsv">
              <svg viewBox="0 0 24 24"><path d="M4 4h16v16H4z" /></svg>CSV
            </div>
            <div class="dropdown-item" id="exportXls">
              <svg viewBox="0 0 24 24"><path d="M4 4h16v16H4z" /></svg>Excel
            </div>
            <div class="dropdown-item" id="exportPdf">
              <svg viewBox="0 0 24 24"><path d="M4 4h16v16H4z" /></svg>PDF
            </div>
          </div>
        </div>

        <button id="refresh" class="primary">Refresh</button>
        <span id="status" class="meta"></span>
      </div>
    </div>

    <div class="kpis">
      <div class="kpi">
        <h3 id="hdr">üßæ Summary</h3>
        <div id="kpi-total" class="value">S$0.00</div>
        <div id="kpi-meta" class="meta">‚Äî</div>
      </div>
      <div class="kpi">
        <h3>üì¶ Categories</h3>
        <div id="kpi-cats" class="value">0</div>
      </div>
      <div class="kpi">
        <h3>üóìÔ∏è Entries</h3>
        <div id="kpi-entries" class="value">0</div>
      </div>
    </div>

    <div class="grid">
      <div class="card viz">
        <div class="section-title">Category Donut</div>
        <canvas id="donut" aria-label="Spending donut chart"></canvas>
        <div id="legend" class="legend"></div>
      </div>

      <div class="card breakdown">
        <div class="section-title">Breakdown</div>
        <table class="table">
          <thead>
            <tr><th>Category</th><th class="amt">Amount</th><th class="pct">Share</th></tr>
          </thead>
          <tbody id="tbl"></tbody>
        </table>
        <p id="quip" class="meta"></p>
      </div>

      <div class="card">
        <div class="section-title">Recent Entries</div>
        <table class="table">
          <thead>
            <tr><th>#</th><th>When (SGT)</th><th>Category</th><th class="amt">Amount</th></tr>
          </thead>
          <tbody id="recent"></tbody>
        </table>
        <p id="empty" class="empty" hidden>No records yet lah üòÖ</p>
      </div>
    </div>

    <div class="meta" id="generatedAt"></div>
  </div>

  <div id="popup"></div>
  <div id="auntie-bubble"></div>

  <script>
    const SG_TZ = "Asia/Singapore";
    const params = new URLSearchParams(location.search);
    const token = params.get("u");
    const $ = id => document.getElementById(id);
    const rand = a => a[Math.floor(Math.random()*a.length)];
    const money = n => "S$" + Number(n).toFixed(2);

    const FOOTERS = ["Steady lah üí™", "Wallet say thank you üôè", "Huat slowly", "Little by little"];
    const SPICE_TAP = ["Aiyo spend again ah?", "Big spender vibes!", "Steady lah you"];

    function showBubble(msg) {
      const b = $("auntie-bubble");
      b.textContent = msg;
      b.style.display = "block";
      setTimeout(() => b.style.display = "none", 4000);
    }

    async function fetchSummary() {
      if (!token) {
        $("status").textContent = "No token found lah üòÖ";
        return null;
      }
      try {
        $("status").textContent = "Fetching‚Ä¶";
        const res = await fetch(`/api/summary?u=${encodeURIComponent(token)}&_=${Date.now()}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        $("status").textContent = "";
        return data;
      } catch(e) {
        console.error(e);
        $("status").textContent = "Error üò¢";
        return null;
      }
    }

    function sizeCanvasForDisplay(canvas) {
      const ratio = window.devicePixelRatio || 1;
      const cssW = canvas.clientWidth;
      const cssH = canvas.clientHeight;
      canvas.width = Math.max(300, Math.floor(cssW * ratio));
      canvas.height = Math.max(200, Math.floor(cssH * ratio));
      const ctx = canvas.getContext("2d");
      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
      return ctx;
    }

    function drawDonut(canvas, rows, total) {
      const ctx = sizeCanvasForDisplay(canvas);
      const W = canvas.clientWidth, H = canvas.clientHeight;
      ctx.clearRect(0,0,W,H);
      const cx = W/2, cy = H/2;
      const outerR = Math.min(W, H)*0.42;
      const innerR = outerR*0.6;
      let start = -Math.PI/2;
      rows.forEach(([cat, amt], i) => {
        const frac = total ? amt/total : 0;
        const angle = frac * Math.PI * 2;
        const end = start + angle;
        ctx.beginPath();
        ctx.moveTo(cx,cy);
        ctx.arc(cx, cy, outerR, start, end);
        ctx.lineTo(cx,cy);
        ctx.fillStyle = donutPalette[i % donutPalette.length];
        ctx.fill();
        rows[i].angle = [start, end];
        start = end;
      });
      ctx.globalCompositeOperation = "destination-out";
      ctx.beginPath();
      ctx.arc(cx, cy, innerR, 0, Math.PI * 2);
      ctx.fill();
      ctx.globalCompositeOperation = "source-over";
      ctx.fillStyle = "#5B3B33";
      ctx.textAlign = "center";
      ctx.font = "700 14px sans-serif";
      ctx.fillText("Total", cx, cy-10);
      ctx.font = "800 20px sans-serif";
      ctx.fillText(money(total), cx, cy+16);
    }

    function exportCSV(rows) {
      const d = new Date().toISOString().slice(0,10);
      let csv = "Category,Amount\n";
      rows.forEach(([c,a]) => csv += `${c},${a}\n`);
      const blob = new Blob([csv], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `auntie-summary-${d}.csv`;
      a.click();
    }

    function exportXLS(rows) {
      exportCSV(rows); // simple fallback
    }

    function exportPDF(rows) {
      const d = new Date().toISOString().slice(0,10);
      const w = window.open("", "", "width=600,height=700");
      w.document.write("<h3>Auntie Can Count Summary</h3><table border=1 cellspacing=0 cellpadding=6><tr><th>Category</th><th>Amount</th></tr>");
      rows.forEach(([c,a]) => w.document.write(`<tr><td>${c}</td><td>${money(a)}</td></tr>`));
      w.document.write("</table>");
      w.print();
      w.close();
    }

    function renderLegend(rows) {
      const legend = $("legend");
      legend.innerHTML = "";
      rows.forEach(([cat], i) => {
        const tag = document.createElement("div");
        tag.className = "tag";
        const dot = document.createElement("span");
        dot.className = "dot";
        dot.style.background = donutPalette[i % donutPalette.length];
        const label = document.createElement("span");
        label.textContent = cat;
        tag.append(dot, label);
        legend.appendChild(tag);
      });
    }

    function renderTable(rows, total) {
      const tbody = $("tbl");
      tbody.innerHTML = "";
      rows.forEach(([cat, amt], i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            <span style="display:inline-flex;align-items:center;gap:8px">
              <span style="width:10px;height:10px;border-radius:3px;background:${donutPalette[i%donutPalette.length]}"></span>
              ${cat}
            </span>
          </td>
          <td class="amt">${money(amt)}</td>
          <td class="pct">${total ? (amt/total*100).toFixed(1) + "%" : "‚Äî"}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderRecent(entries) {
      const tbody = $("recent");
      tbody.innerHTML = "";
      if (!entries.length) {
        $("empty").hidden = false;
        return;
      } else {
        $("empty").hidden = true;
      }
      entries.slice(-10).reverse().forEach((e,i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${new Date(e.date).toLocaleString("en-SG", { timeZone: SG_TZ, hour12: false })}</td>
          <td>${e.category || "uncategorised"}</td>
          <td class="amt">${money(e.amount||0)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    const donutPalette = [
      getCSS('--slice-1'), getCSS('--slice-2'), getCSS('--slice-3'),
      getCSS('--slice-4'), getCSS('--slice-5'), getCSS('--slice-6'),
      getCSS('--slice-7'), getCSS('--slice-8'), getCSS('--slice-9'),
      getCSS('--slice-10')
    ];
    function getCSS(name) {
      return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    }

    document.querySelectorAll(".dropdown-btn").forEach(btn => {
      btn.addEventListener("click", e => {
        const parent = btn.closest(".dropdown");
        parent.classList.toggle("open");
        document.querySelectorAll(".dropdown").forEach(d => {
          if (d !== parent) d.classList.remove("open");
        });
        e.stopPropagation();
      });
    });
    document.body.addEventListener("click", () => {
      document.querySelectorAll(".dropdown").forEach(d => d.classList.remove("open"));
    });

    $("rangeMenu").querySelectorAll(".dropdown-item").forEach(item => {
      item.addEventListener("click", () => {
        const r = item.getAttribute("data-range");
        $("rangeBtn").textContent = item.textContent + " ‚ñæ";
        document.querySelectorAll(".dropdown").forEach(d => d.classList.remove("open"));
        load(r);
      });
    });
    $("exportCsv").addEventListener("click", () => exportCSV(currentRows));
    $("exportXls").addEventListener("click", () => exportXLS(currentRows));
    $("exportPdf").addEventListener("click", () => exportPDF(currentRows));

    let currentRows = [];

    async function load(range = "week") {
      const data = await fetchSummary();
      if (!data) return;
      const entries = data.entries || [];
      const now = new Date();
      let scoped;
      if (range === "all") {
        scoped = entries;
      } else if (range === "month") {
        scoped = entries.filter(e => {
          const d = new Date(e.date);
          return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
        });
      } else {
        const weekStart = new Date(now);
        weekStart.setDate(now.getDate() - 6);
        scoped = entries.filter(e => new Date(e.date) >= weekStart);
      }

      const byCat = {};
      let total = 0;
      scoped.forEach(e => {
        const c = e.category || "uncategorised";
        const a = Number(e.amount || 0);
        byCat[c] = (byCat[c] || 0) + a;
        total += a;
      });
      const rows = Object.entries(byCat).sort((a,b) => b[1] - a[1]);
      currentRows = rows;

      $("kpi-total").textContent = money(total);
      $("kpi-cats").textContent = rows.length;
      $("kpi-entries").textContent = scoped.length;

      $("hdr").textContent =
        range === "month" ? "üßæ This Month Summary" :
        range === "all" ? "üßæ All-Time Summary" :
        "üßæ This Week Summary";

      drawDonut($("donut"), rows, total);
      renderLegend(rows);
      renderTable(rows, total);
      renderRecent(scoped);

      showBubble(rand(FOOTERS));
    }

    $("refresh").addEventListener("click", () => {
      load();
      showBubble("Auntie refreshed your summary ‚ú®");
    });

    window.addEventListener("resize", () => {
      if (currentRows.length > 0) {
        drawDonut($("donut"), currentRows, currentRows.reduce((s,[,a])=>s+a,0));
      }
    });

    load();

  </script>
</body>
</html>
