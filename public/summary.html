<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Auntie Can Count One | Summary</title>

<style>
:root{
  --desert-flower:#E98C7A;
  --blue-curacao:#58B8C7;
  --bg:#FFF9F6;
  --ink:#1F2328;
  --muted:#6B7280;
  --card:#FFF;
  --ring:#F0E6DE;
  --radius:16px;
  --shadow:0 12px 30px rgba(0,0,0,.06);
  --brand:var(--desert-flower);
  --brand-ink:#7C3E33;
}
*{box-sizing:border-box}
body{margin:0;font-family:ui-sans-serif,system-ui,"Segoe UI",Roboto;
  color:var(--ink);
  background:linear-gradient(#FFFDFC,var(--bg));}
.app{max-width:1100px;margin:auto;padding:20px clamp(14px,3vw,24px) 40px;display:grid;gap:16px;}
.topbar{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;}
.brand{display:flex;align-items:center;gap:12px;}
.logo{
  width:42px;height:42px;border-radius:12px;
  background:linear-gradient(145deg,#C0EEF2,#F4F8F9);
  box-shadow:var(--shadow);display:flex;align-items:center;justify-content:center;
}
.logo svg{width:26px;height:26px;stroke:#000;fill:none;stroke-width:1.8;}
h1{margin:0;font-size:clamp(1.1rem,1vw+1rem,1.5rem);color:var(--brand-ink);}
.sub{margin:0;color:var(--muted);font-size:.95rem;}
.controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
button.primary{background:linear-gradient(180deg,#FFE7E1 0%,#FFD9D0 100%);border:1px solid #FFD2C8;
  border-radius:12px;padding:10px 14px;font-weight:700;color:#6E362D;cursor:pointer;}
.meta{color:var(--muted);font-size:.9rem;}
.dropdown{position:relative;}
.dropdown-btn{
  background:linear-gradient(180deg,#FDF7F5 0%,#FCEFEA 100%);
  border:1px solid var(--ring);
  border-radius:12px;
  padding:10px 14px;
  font-weight:600;
  color:#333;
  cursor:pointer;
  display:flex;align-items:center;gap:6px;
  transition:.2s;
}
.dropdown-btn:hover{border-color:var(--blue-curacao);}
.dropdown-menu{
  position:absolute;top:110%;right:0;
  background:#fff;
  border:1px solid var(--ring);
  border-radius:12px;
  box-shadow:0 6px 20px rgba(0,0,0,.08);
  min-width:160px;
  padding:6px 0;
  opacity:0;pointer-events:none;
  transform:translateY(8px);
  transition:opacity .25s ease,transform .25s ease;
  z-index:100;
}
.dropdown.open .dropdown-menu{opacity:1;pointer-events:auto;transform:translateY(0);}
.dropdown-item{
  padding:10px 14px;display:flex;align-items:center;gap:8px;
  color:#333;font-size:.95rem;cursor:pointer;
  transition:.15s;
}
.dropdown-item:hover{background:linear-gradient(90deg,#E8FAFC,#fff);}
.dropdown-item svg{width:16px;height:16px;stroke:#555;stroke-width:1.6;fill:none;}
.kpis{grid-column:1/-1;display:grid;gap:16px;grid-template-columns:repeat(12,1fr);}
.kpi{grid-column:span 4;background:#fff;border:1px solid var(--ring);
  border-radius:14px;padding:14px 16px;box-shadow:var(--shadow);}
.kpi h3{margin:0 0 4px;font-size:.9rem;color:var(--muted);}
.value{font-weight:800;font-size:1.4rem;color:var(--brand-ink);}
.grid{display:grid;gap:16px;grid-template-columns:repeat(12,1fr);}
.card{background:var(--card);border:1px solid var(--ring);border-radius:var(--radius);
  box-shadow:var(--shadow);padding:20px;}
.section-title{margin:0 0 10px;font-weight:800;color:#6E2B20;}
#popup{position:absolute;display:none;pointer-events:none;background:#fff;border:1px solid var(--ring);
  border-radius:8px;padding:6px 10px;box-shadow:var(--shadow);font-size:.85rem;color:#333;z-index:999;}
#auntie-bubble{position:fixed;bottom:16px;right:16px;max-width:240px;
  background:#FFF3EE;border:1px solid var(--ring);border-radius:16px;padding:12px 14px;
  box-shadow:var(--shadow);font-size:.9rem;color:#7C3E33;display:none;animation:fadeIn .4s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
</style>
</head>

<body>
<div class="app">
  <div class="topbar">
    <div class="brand">
      <div class="logo">
        <!-- flat minimalist Auntie SVG -->
        <svg viewBox="0 0 64 64"><circle cx="32" cy="32" r="28" stroke="#000" fill="none"/><path d="M20 36c4 6 20 6 24 0M24 28h16M26 24a2 2 0 1 1 0-4M38 24a2 2 0 1 1 0-4"/></svg>
      </div>
      <div>
        <h1>Auntie Can Count One ‚Äî Summary</h1>
        <p class="sub">Pastel Pantone dashboard. Donut so tiny but shiok üç©</p>
      </div>
    </div>
    <div class="controls">
      <!-- Range dropdown -->
      <div class="dropdown" id="rangeDrop">
        <div class="dropdown-btn" id="rangeBtn">This Week ‚ñæ</div>
        <div class="dropdown-menu" id="rangeMenu">
          <div class="dropdown-item" data-range="week">This Week</div>
          <div class="dropdown-item" data-range="month">This Month</div>
          <div class="dropdown-item" data-range="all">All Time</div>
        </div>
      </div>

      <!-- Export dropdown -->
      <div class="dropdown" id="exportDrop">
        <div class="dropdown-btn" id="exportBtn">Export ‚ñæ</div>
        <div class="dropdown-menu" id="exportMenu">
          <div class="dropdown-item" id="exportCsv">
            <svg viewBox="0 0 24 24"><path d="M4 4h16v16H4z"/><path d="M8 8h8v8H8z"/></svg>CSV
          </div>
          <div class="dropdown-item" id="exportXls">
            <svg viewBox="0 0 24 24"><path d="M4 4h16v16H4z"/><path d="M8 8l8 8M16 8l-8 8"/></svg>Excel
          </div>
          <div class="dropdown-item" id="exportPdf">
            <svg viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M8 8h8v8H8z"/></svg>PDF
          </div>
        </div>
      </div>

      <button id="refresh" class="primary">Refresh</button>
      <span id="status" class="meta"></span>
    </div>
  </div>

  <!-- KPI + cards remain -->
  <div class="kpis">
    <div class="kpi"><h3 id="hdr">üßæ Summary</h3><div id="kpi-total" class="value">S$0.00</div><div id="kpi-meta" class="meta">‚Äî</div></div>
    <div class="kpi"><h3>üì¶ Categories</h3><div id="kpi-cats" class="value">0</div></div>
    <div class="kpi"><h3>üóìÔ∏è Entries</h3><div id="kpi-entries" class="value">0</div></div>
  </div>

  <div class="grid">
    <div class="card viz">
      <div class="section-title">Category Donut</div>
      <canvas id="donut" style="width:100%;max-width:640px;aspect-ratio:13/8;"></canvas>
      <div id="legend" class="legend"></div>
    </div>
    <div class="card breakdown">
      <div class="section-title">Breakdown</div>
      <table class="table"><thead><tr><th>Category</th><th>Amount</th><th>%</th></tr></thead><tbody id="tbl"></tbody></table>
      <p id="quip" class="meta"></p>
    </div>
  </div>
  <div id="generatedAt" class="meta"></div>
</div>

<div id="popup"></div>
<div id="auntie-bubble"></div>

<script>
const $=id=>document.getElementById(id);
function toggleDrop(el){el.classList.toggle("open");document.querySelectorAll(".dropdown").forEach(d=>{if(d!==el)d.classList.remove("open");});}
document.body.addEventListener("click",e=>{if(!e.target.closest(".dropdown"))document.querySelectorAll(".dropdown").forEach(d=>d.classList.remove("open"));});
["rangeDrop","exportDrop"].forEach(id=>{$(id).querySelector(".dropdown-btn").onclick=()=>toggleDrop($(id));});
["rangeMenu"].forEach(id=>{
  $(id).querySelectorAll(".dropdown-item").forEach(it=>it.onclick=()=>{
    $("rangeBtn").textContent=it.textContent+" ‚ñæ";
    document.querySelectorAll(".dropdown").forEach(d=>d.classList.remove("open"));
    load(it.dataset.range);
  });
});

function showBubble(msg){const b=$("auntie-bubble");b.textContent=msg;b.style.display="block";setTimeout(()=>b.style.display="none",4000);}
const money=n=>"S$"+Number(n).toFixed(2);
const rand=a=>a[Math.floor(Math.random()*a.length)];
const FOOTERS=["Steady lah üí™","Budget got eyes one üëÄ","Treat savings also üê∑","Wallet say thank you üôè"];
const SPICE_TAP=["Aiyo spend again ah? üòÇ","This one confirm Shopee üòÖ","Wah big spender! üí∏","Steady lah you"];
const donutPalette=["#E98C7A","#58B8C7","#C17BA3","#D1AE3A","#8E3D79"];
const token=new URLSearchParams(location.search).get("u");
async function fetchSummary(){
 if(!token){$("status").textContent="No token found lah üòÖ";return null;}
 try{$("status").textContent="Fetching‚Ä¶";const r=await fetch(`/api/summary?u=${encodeURIComponent(token)}&_=${Date.now()}`);
 const d=await r.json();$("status").textContent="";return d;}catch(e){$("status").textContent="Error üò¢";return null;}
}
function drawDonut(c,rows,total){
 const ctx=c.getContext("2d");const W=c.width=c.clientWidth,H=c.height=c.clientHeight;
 const cx=W/2,cy=H/2,outerR=Math.min(W,H)*0.4,innerR=outerR*0.6;ctx.clearRect(0,0,W,H);
 let start=-Math.PI/2;rows.forEach(([cat,amt],i)=>{const frac=amt/total,ang=frac*Math.PI*2,end=start+ang;
 ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,outerR,start,end);ctx.lineTo(cx,cy);
 ctx.fillStyle=donutPalette[i%donutPalette.length];ctx.fill();rows[i].angle=[start,end];start=end;});
 ctx.globalCompositeOperation="destination-out";ctx.beginPath();ctx.arc(cx,cy,innerR,0,Math.PI*2);ctx.fill();ctx.globalCompositeOperation="source-over";
 ctx.fillStyle="#5B3B33";ctx.textAlign="center";ctx.font="700 14px sans-serif";ctx.fillText("Total",cx,cy-10);
 ctx.font="800 20px sans-serif";ctx.fillText(money(total),cx,cy+16);
}
function exportCSV(rows){const d=new Date().toISOString().slice(0,10);
 let csv="Category,Amount\n";rows.forEach(([c,a])=>csv+=`${c},${a}\n`);
 const b=new Blob([csv],{type:"text/csv"});const a=document.createElement("a");
 a.href=URL.createObjectURL(b);a.download=`auntie-summary-${d}.csv`;a.click();}
function exportExcel(rows){exportCSV(rows);}
function exportPDF(rows){const d=new Date().toISOString().slice(0,10);
 const w=window.open("","","width=600,height=700");w.document.write("<h3>Auntie Can Count Summary</h3>");
 w.document.write("<table border=1><tr><th>Category</th><th>Amount</th></tr>");
 rows.forEach(([c,a])=>w.document.write(`<tr><td>${c}</td><td>${money(a)}</td></tr>`));
 w.document.write("</table>");w.print();w.close();}
$("exportCsv").onclick=()=>exportCSV(currentRows);
$("exportXls").onclick=()=>exportExcel(currentRows);
$("exportPdf").onclick=()=>exportPDF(currentRows);
let currentRows=[];
async function load(range="week"){
 const data=await fetchSummary();if(!data)return;
 const entries=data.entries||[];const now=new Date();
 const filtered=range==="all"?entries:entries.filter(e=>{
   const d=new Date(e.date);
   if(range==="month")return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear();
   const diff=(now-d)/86400000;return diff<=7;});
 const byCat={};let total=0;
 filtered.forEach(e=>{const c=e.category||"Uncategorised";const a=+e.amount||0;byCat[c]=(byCat[c]||0)+a;total+=a;});
 const rows=Object.entries(byCat).sort((a,b)=>b[1]-a[1]);currentRows=rows;
 $("kpi-total").textContent=money(total);
 $("kpi-cats").textContent=rows.length;
 $("kpi-entries").textContent=filtered.length;
 $("hdr").textContent=`üßæ ${range==="month"?"This Month":range==="all"?"All-Time":"This Week"} Summary`;
 drawDonut($("donut"),rows,total);
 showBubble(rand(FOOTERS));
 const donut=$("donut"),popup=$("popup");
 donut.onclick=e=>{
   const rect=donut.getBoundingClientRect();const x=e.clientX-rect.left;const y=e.clientY-rect.top;
   const cx=rect.width/2,cy=rect.height/2;const dx=x-cx,dy=y-cy;const t=Math.atan2(dy,dx);
   rows.forEach(([cat,amt],i)=>{const[st,en]=rows[i].angle;if(t>st&&t<en){
     popup.style.left=e.pageX+"px";popup.style.top=e.pageY+"px";
     popup.innerHTML=`<b>${cat}</b><br>${money(amt)} (${(amt/total*100).toFixed(1)}%)`;
     popup.style.display="block";showBubble(rand(SPICE_TAP));}});
 };
 document.body.onclick=ev=>{if(!donut.contains(ev.target))popup.style.display="none";};
}
$("refresh").onclick=()=>load();
load();
</script>
</body>
</html>
