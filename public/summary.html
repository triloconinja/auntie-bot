<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Auntie Can Count One | Summary</title>

<!-- Open Graph -->
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Auntie Can Count One" />
<meta property="og:title" content="Auntie Can Count One ‚Äî Summary" />
<meta property="og:description" content="Track your weekly & monthly spending in SGD. Tiny donut, big insights. üç©" />
<meta property="og:url" content="https://auntie-bot.onrender.com/summary.html" />
<meta property="og:image" content="https://auntie-bot.onrender.com/images/auntie-summary-preview.png" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Auntie Can Count One ‚Äî Summary" />
<meta name="twitter:description" content="Track your weekly & monthly spending in SGD. Tiny donut, big insights. üç©" />
<meta name="twitter:image" content="https://auntie-bot.onrender.com/images/auntie-summary-preview.png" />

<style>
:root{
  /* Pantone palette */
  --desert-flower:#E98C7A;
  --blue-curacao:#58B8C7;
  --opera-mauve:#C17BA3;
  --spicy-mustard:#D1AE3A;
  --mocha-mousse:#9B6B58;
  --cattleya-orchid:#8E3D79;

  /* UI */
  --bg:#FFF9F6;
  --ink:#1F2328;
  --muted:#6B7280;
  --ring:#F0E6DE;
  --shadow:0 10px 24px rgba(0,0,0,.06);

  /* panel tints */
  --panel-kpi:#F9F6F4;
  --panel-viz:#F7FAFA;
  --panel-breakdown:#F9F6F8;
  --panel-list:#FAF8F4;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:ui-sans-serif,system-ui,"Segoe UI",Roboto,Arial;
  color:var(--ink);
  background:
    radial-gradient(1200px 600px at 10% -10%, rgba(233,140,122,.16), transparent 60%),
    radial-gradient(1000px 500px at 110% 0%, rgba(88,184,199,.14), transparent 60%),
    linear-gradient(#FFFDFC,var(--bg));
  overflow-x:hidden;
}
.app{max-width:1100px;margin:auto;padding:20px clamp(14px,3vw,24px) 40px;display:grid;gap:16px;}
/* Top bar */
.topbar{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;}
.brand{display:flex;align-items:center;gap:12px;}
.logo{
  width:48px;height:48px;border-radius:12px;
  background:linear-gradient(145deg,#FFE4DD,#E3F7FA);
  display:grid;place-items:center;box-shadow:var(--shadow);
}
.logo svg{width:30px;height:30px;stroke:#2B2B2B;fill:none;stroke-width:2;}
h1{margin:0;font-size:clamp(1.1rem,1vw+1rem,1.5rem);color:var(--mocha-mousse);}
.sub{margin:0;color:var(--muted);font-size:.95rem}
/* Controls */
.controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.dropdown{position:relative}
.dropdown-btn{
  background:linear-gradient(180deg,#FDF7F5 0%,#F3EBE6 100%);
  border:1px solid var(--ring); border-radius:12px;
  padding:10px 14px; font-weight:600; color:var(--ink);
  cursor:pointer; display:flex; align-items:center; gap:6px;
  transition:border-color .2s; white-space:nowrap;
}
.dropdown-btn:hover{border-color:var(--blue-curacao);}
.dropdown-menu{
  position:absolute; top:110%; left:0; background:#fff;
  border:1px solid var(--ring); border-radius:12px;
  box-shadow:0 8px 24px rgba(0,0,0,.08);
  min-width:170px; padding:6px 0; z-index:100;
  opacity:0; pointer-events:none; transform:translateY(8px);
  transition:opacity .25s ease, transform .25s ease;
}
.dropdown.open .dropdown-menu{opacity:1; pointer-events:auto; transform:translateY(0);}
.dropdown-item{
  padding:10px 14px; display:flex; align-items:center; gap:8px;
  color:var(--ink); font-size:.95rem; cursor:pointer;
}
.dropdown-item:hover{background:linear-gradient(90deg,#E8FAFC,#fff);}
.dropdown-item.sep{ height:1px; background:var(--ring); margin:6px 10px; }
.dropdown-item.danger{ color:#B91C1C; font-weight:700; }

/* Refresh */
button.primary{
  background:linear-gradient(180deg,#FFE7E1 0%,#FFD9D0 100%);
  border:1px solid #FFD2C8; border-radius:12px;
  height:40px; min-width:120px;
  padding:0 14px; font-weight:700; color:#6E362D; cursor:pointer;
  display:flex; align-items:center; justify-content:center; white-space:nowrap;
}
.meta{color:var(--muted);font-size:.9rem}

/* Panels */
.kpis{
  display:grid; gap:16px;
  grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
}
.kpi{
  background:var(--panel-kpi);
  border:1px solid var(--ring); border-radius:16px;
  box-shadow:var(--shadow); padding:16px;
}
.kpi h3{margin-bottom:4px;font-size:.9rem;color:var(--muted)}
.value{font-weight:800;font-size:clamp(1.2rem, 0.9rem + 1vw, 1.6rem);color:var(--ink)}
.kpi-summary{} .kpi-cats{} .kpi-entries{}

.grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(320px,1fr))}
.card{border:1px solid var(--ring);border-radius:16px;box-shadow:var(--shadow);padding:20px}
.viz{background:var(--panel-viz)}
.breakdown{background:var(--panel-breakdown)}
.list{background:var(--panel-list)}
.section-title{margin-bottom:10px;font-weight:800;color:#6E2B20}

/* Tables */
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:12px;border-bottom:1px solid #EFE6DD;text-align:left;font-size:.95rem}
.table th{background:#FFF3EE;color:#7A5D57}
.amt{text-align:right}
.pct{color:var(--muted);font-size:.9rem;text-align:right}

/* Recent Entries: compact, responsive text */
.table-recent th,.table-recent td{
  font-size: clamp(.76rem, .70rem + .28vw, .92rem);
  line-height: 1.15;
  padding: 8px 10px;
}
.table-recent .amt{ font-variant-numeric: tabular-nums; }

/* Legend & donut */
.legend{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.tag{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#FFF7F2;border:1px solid var(--ring);font-size:.9rem}
.dot{width:12px;height:12px;border-radius:3px}
canvas{width:100% !important;height:auto !important}

/* Tooltip & one-time bubble */
#popup{position:absolute;display:none;pointer-events:none;background:#fff;border:1px solid var(--ring);border-radius:8px;padding:6px 10px;box-shadow:var(--shadow);font-size:.85rem;color:#333;z-index:999}
#auntie-bubble{
  position:fixed;bottom:16px;right:16px;max-width:260px;
  background:#FFFFFF;border:1px solid var(--ring);border-radius:16px;
  padding:12px 14px; box-shadow:var(--shadow);
  color:#6E2B20; display:none; animation:fadeIn .4s ease;
}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* Floating bookmark FAB + feedback panel */
#feedbackFab{
  position:fixed; right:16px; bottom:96px;
  width:48px; height:48px; border-radius:12px;
  background:linear-gradient(180deg,#F6FBFF 0%, #EAF6FF 100%);
  border:1px solid #D9E7F5; box-shadow:var(--shadow);
  display:grid; place-items:center; cursor:pointer; z-index:1100;
}
#feedbackFab svg{width:22px;height:22px;stroke:#2563eb;fill:none;stroke-width:2;}
#feedbackPanel{
  position:fixed; right:16px; bottom:160px; z-index:1100;
  width:min(380px,92vw); background:#fff; color:var(--ink);
  border:1px solid var(--ring); border-radius:16px; box-shadow:var(--shadow);
  padding:14px; opacity:0; transform:translateY(8px);
  pointer-events:none; transition:opacity .25s ease, transform .25s ease;
}
#feedbackPanel.open{ opacity:1; transform:translateY(0); pointer-events:auto; }
#feedbackPanel h4{ margin:0 0 8px; font-size:1rem; color:#6E2B20; }
#feedbackPanel textarea{
  width:100%; min-height:110px; resize:vertical;
  border:1px solid var(--ring); border-radius:12px; padding:10px;
  font-family:inherit; font-size:.95rem; background:#FFFEFD;
}
#feedbackPanel .row{display:flex; gap:8px; margin-top:10px;}
#feedbackPanel button{
  background:linear-gradient(180deg,#DFF6E7 0%,#CDEEDA 100%);
  border:1px solid #BFE7CD; color:#165534; font-weight:700;
  padding:10px 14px; border-radius:12px; cursor:pointer;
}
#fbStatus{ color:var(--muted); font-size:.9rem; margin-left:6px; align-self:center; }

/* Mobile layout */
@media (max-width: 680px){
  .kpis{ grid-template-columns: repeat(2, minmax(0,1fr)); }
  .kpi-summary{ grid-column: 1 / -1; }
  .kpi-cats, .kpi-entries{ grid-column: span 1; }
}
</style>
</head>

<body>
<div class="app">
  <div class="topbar">
    <div class="brand">
      <div class="logo" aria-label="Auntie logo">
        <svg viewBox="0 0 64 64" role="img" aria-hidden="true">
          <circle cx="32" cy="32" r="28"/>
          <circle cx="32" cy="26" r="10"/>
          <path d="M18 48c8-10 20-10 28 0"/>
        </svg>
      </div>
      <div>
        <h1>Auntie Can Count One ‚Äî Summary</h1>
        <p class="sub">Pastel Pantone dashboard. Donut so tiny but shiok üç©</p>
      </div>
    </div>

    <div class="controls">
      <!-- Range dropdown -->
      <div class="dropdown" id="rangeDrop">
        <div class="dropdown-btn" id="rangeBtn">This Week ‚ñæ</div>
        <div class="dropdown-menu" id="rangeMenu">
          <div class="dropdown-item" data-range="week">This Week</div>
          <div class="dropdown-item" data-range="month">This Month</div>
          <div class="dropdown-item" data-range="all">All Time</div>
        </div>
      </div>

      <!-- Export dropdown -->
      <div class="dropdown" id="exportDrop">
        <div class="dropdown-btn" id="exportBtn">Export ‚ñæ</div>
        <div class="dropdown-menu" id="exportMenu">
          <div class="dropdown-item" id="exportCsv">üìÑ CSV</div>
          <div class="dropdown-item" id="exportXls">üìä Excel</div>
          <div class="dropdown-item" id="exportPdf">üñ®Ô∏è PDF</div>
          <div class="dropdown-item sep" role="separator"></div>
          <div class="dropdown-item danger" id="clearData">üßπ Clear My Data</div>
        </div>
      </div>

      <button id="refresh" class="primary">Refresh</button>
      <span id="status" class="meta"></span>
    </div>
  </div>

  <!-- KPIs -->
  <div class="kpis">
    <div class="kpi kpi-summary">
      <h3 id="hdr">üßæ Summary</h3>
      <div id="kpi-total" class="value">S$0.00</div>
      <div id="kpi-meta" class="meta">‚Äî</div>
    </div>
    <div class="kpi kpi-cats">
      <h3>üì¶ Categories</h3>
      <div id="kpi-cats" class="value">0</div>
    </div>
    <div class="kpi kpi-entries">
      <h3>üóìÔ∏è Entries</h3>
      <div id="kpi-entries" class="value">0</div>
    </div>
  </div>

  <!-- Panels -->
  <div class="grid">
    <div class="card viz">
      <div class="section-title">Category Donut</div>
      <canvas id="donut" aria-label="Spending donut chart"></canvas>
      <div id="legend" class="legend"></div>
    </div>

    <div class="card breakdown">
      <div class="section-title">Breakdown</div>
      <table class="table" aria-label="Category breakdown table">
        <thead><tr><th>Category</th><th class="amt">Amount</th><th class="pct">Share</th></tr></thead>
        <tbody id="tbl"></tbody>
      </table>
    </div>

    <div class="card list">
      <div class="section-title">Recent Entries</div>
      <table class="table table-recent" aria-label="Recent entries">
        <thead><tr><th>#</th><th>When (SGT)</th><th>Category</th><th class="amt">Amount</th></tr></thead>
        <tbody id="recent"></tbody>
      </table>
      <p id="empty" class="meta" hidden>No records yet lah üòÖ</p>
    </div>
  </div>

  <div class="meta" id="generatedAt"></div>
</div>

<!-- Tooltip + one-time bubble -->
<div id="popup"></div>
<div id="auntie-bubble"></div>

<!-- Floating bookmark FAB + Feedback Panel -->
<button id="feedbackFab" aria-label="Feedback">
  <svg viewBox="0 0 24 24"><path d="M6 3h12v18l-6-4-6 4z"/></svg>
</button>
<div id="feedbackPanel" role="dialog" aria-modal="true" aria-labelledby="fbTitle">
  <h4 id="fbTitle">Feedback to Auntie</h4>
  <textarea id="fbText" placeholder="Tell Auntie what to improve‚Ä¶"></textarea>
  <div class="row">
    <button id="fbSubmit">Submit</button>
    <span id="fbStatus" aria-live="polite"></span>
  </div>
</div>

<script>
/* ========= Helpers ========= */
const SG_TZ="Asia/Singapore";
const token=new URLSearchParams(location.search).get("u");
const $=id=>document.getElementById(id);

/* rounding + formatting */
const STEP=0.10;
const roundToStep=(n,step=STEP)=>Math.round((Number(n)||0)/step)*step;

/* Intl currency with thousands (S$) */
const sgdFmt = new Intl.NumberFormat("en-SG", {
  style: "currency",
  currency: "SGD",
  minimumFractionDigits: 2,
  maximumFractionDigits: 2
});
const numFmt = new Intl.NumberFormat("en-SG", {
  minimumFractionDigits: 2,
  maximumFractionDigits: 2
});
const money = n => sgdFmt.format(roundToStep(n));

const capFirst=s=>{s=String(s||"uncategorised").trim();return s? s[0].toUpperCase()+s.slice(1):s;};
const truncDonut=s=>{s=capFirst(s);return s.length>10? s.slice(0,10)+"...":s;};
const truncBreakdown=s=>{s=capFirst(s);return s.length>12? s.slice(0,12):s;};
const truncRecent=s=>{s=capFirst(s);return s.length>13? s.slice(0,13):s;};

const donutPalette=["#E98C7A","#58B8C7","#C17BA3","#8E3D79","#D1AE3A","#9B6B58"];

/* one-time greeting per load */
function maybeShowOneTimeGreeting(){
  if(!sessionStorage.getItem("auntie_greeted")){
    showBubble("Steady lah üí™ track first then spend!");
    sessionStorage.setItem("auntie_greeted","1");
  }
}
function showBubble(msg){
  const b=$("auntie-bubble"); b.textContent=msg; b.style.display="block";
  setTimeout(()=>b.style.display="none",6000);
}

/* data */
async function fetchSummary(){
  if(!token){$("status").textContent="No token found lah üòÖ";return null;}
  try{
    $("status").textContent="Fetching‚Ä¶";
    const res=await fetch(`/api/summary?u=${encodeURIComponent(token)}&_=${Date.now()}`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data=await res.json(); $("status").textContent=""; return data;
  }catch(e){ console.error(e); $("status").textContent="Error üò¢"; return null; }
}

/* donut sizing + draw + state for hit-test */
const donutState={cx:0,cy:0,innerR:0,outerR:0,rows:[], sliceAngles:[], lastShownIndex:-1};

function sizeCanvasForDisplay(c){
  const ratio=window.devicePixelRatio||1;
  const cssW=c.clientWidth, cssH=Math.max(240, c.clientWidth*0.62);
  c.style.height=cssH+"px";
  c.width=Math.floor(cssW*ratio); c.height=Math.floor(cssH*ratio);
  const ctx=c.getContext('2d'); ctx.setTransform(ratio,0,0,ratio,0,0);
  return ctx;
}

function drawDonut(c, rows, total){
  const ctx = sizeCanvasForDisplay(c);
  const W = c.clientWidth, H = c.clientHeight;
  ctx.clearRect(0,0,W,H);

  // Donut geometry
  const cx = W/2, cy = H/2;
  const outerR = Math.min(W,H)*0.42;
  const innerR = outerR*0.6;
  Object.assign(donutState,{cx,cy,outerR,innerR,rows, sliceAngles:[], lastShownIndex:-1});

  // Slices
  let start = -Math.PI/2;
  rows.forEach(([cat,amt],i)=>{
    const frac = total ? amt/total : 0;
    const angle = frac * Math.PI*2;
    const end = start + angle;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,outerR,start,end);
    ctx.lineTo(cx,cy);
    ctx.fillStyle = donutPalette[i%donutPalette.length];
    ctx.fill();
    donutState.sliceAngles[i] = [start,end];
    start = end;
  });

  // Hole
  const prev = ctx.globalCompositeOperation;
  ctx.globalCompositeOperation = "destination-out";
  ctx.beginPath(); ctx.arc(cx,cy,innerR,0,Math.PI*2); ctx.fill();
  ctx.globalCompositeOperation = prev;

  // --- Center labels with auto-fit for long amounts ---
  const amountText = money(total); // e.g., "S$100,000.00"

  // Base sizes scale with canvas width
  let amountSizeBase = Math.max(18, Math.min(28, Math.floor(W*0.06)));
  let labelSize = Math.max(12, Math.min(16, Math.floor(amountSizeBase*0.65)));

  // If number is big (>=100k), start smaller on mobile-ish widths
  if (total >= 100000 && W <= 520) amountSizeBase = Math.max(14, amountSizeBase - 6);

  // Fit amount text within ~85% of inner diameter
  const maxTextWidth = innerR * 2 * 0.85;
  let amountSize = amountSizeBase;
  ctx.textAlign = "center";
  ctx.fillStyle = "#5B3B33";

  // Shrink until it fits (safety floor at 12px)
  ctx.font = `800 ${amountSize}px ui-sans-serif`;
  while (ctx.measureText(amountText).width > maxTextWidth && amountSize > 12){
    amountSize -= 1;
    ctx.font = `800 ${amountSize}px ui-sans-serif`;
  }

  // Draw label + amount
  ctx.font = `700 ${labelSize}px ui-sans-serif`;
  ctx.fillText("Total", cx, cy-10);
  ctx.font = `800 ${amountSize}px ui-sans-serif`;
  ctx.fillText(amountText, cx, cy+16);
}

/* renderers */
function renderLegend(rows){
  const legend=$("legend"); legend.innerHTML="";
  rows.forEach(([cat],i)=>{
    const tag=document.createElement("div"); tag.className="tag";
    const dot=document.createElement("span"); dot.className="dot";
    dot.style.background=donutPalette[i%donutPalette.length];
    const label=document.createElement("span"); label.textContent=truncDonut(cat);
    tag.append(dot,label); legend.appendChild(tag);
  });
}
function renderTable(rows,total){
  const tbody=$("tbl"); tbody.innerHTML="";
  rows.forEach(([cat,amt],i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><span style="display:inline-flex;align-items:center;gap:8px">
        <span style="width:10px;height:10px;border-radius:3px;background:${donutPalette[i%donutPalette.length]}"></span>
        ${truncBreakdown(cat)}
      </span></td>
      <td class="amt">${money(amt)}</td>
      <td class="pct">${total?(amt/total*100).toFixed(1)+"%":"‚Äî"}</td>`;
    tbody.appendChild(tr);
  });
}
function renderRecent(entries){
  const tbody=$("recent"); tbody.innerHTML="";
  if(!entries.length){$("empty").hidden=false; return;}
  $("empty").hidden=true;
  entries.slice(-10).reverse().forEach((e,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${i+1}</td>
      <td>${new Date(e.date).toLocaleString("en-SG",{timeZone:SG_TZ,hour12:false})}</td>
      <td>${truncRecent(e.category||"uncategorised")}</td>
      <td class="amt">${money(e.amount||0)}</td>`;
    tbody.appendChild(tr);
  });
}

/* ===== Exports (CSV fixed with quoting + BOM) ===== */
function csvCell(v){
  const s = String(v ?? "");
  return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
}
function exportCSV(rows){
  const d=new Date().toISOString().slice(0,10);
  let csv="Category,Amount (SGD)\n";
  rows.forEach(([c,a])=>{
    const cat = csvCell(capFirst(c));
    const amt = csvCell(numFmt.format(roundToStep(a))); // may contain thousands commas
    csv += `${cat},${amt}\n`;
  });
  const blob=new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`auntie-summary-${d}.csv`; a.click();
}
// Map ‚ÄúExcel‚Äù button to CSV for maximum compatibility
function exportExcel(rows){ exportCSV(rows); }
function exportPDF(rows){
  const d=new Date().toISOString().slice(0,10);
  const w=window.open("","","width=720,height=820");
  w.document.write("<h3>Auntie Can Count Summary</h3><table border=1 cellspacing=0 cellpadding=6><tr><th>Category</th><th>Amount</th></tr>");
  rows.forEach(([c,a])=>w.document.write(`<tr><td>${capFirst(c)}</td><td>${sgdFmt.format(roundToStep(a))}</td></tr>`));
  w.document.write("</table>"); w.print(); w.close();
}

/* dropdowns */
function toggleDrop(el){
  el.classList.toggle("open");
  document.querySelectorAll(".dropdown").forEach(d=>{ if(d!==el) d.classList.remove("open"); });
}
document.body.addEventListener("click",e=>{
  if(!e.target.closest(".dropdown")) document.querySelectorAll(".dropdown").forEach(d=>d.classList.remove("open"));
});
document.querySelectorAll(".dropdown-btn").forEach(btn=>{
  btn.addEventListener("click",e=>{ toggleDrop(btn.closest(".dropdown")); e.stopPropagation(); });
});
document.querySelectorAll("#rangeMenu .dropdown-item").forEach(it=>{
  it.addEventListener("click",()=>{
    $("rangeBtn").textContent = it.textContent + " ‚ñæ";
    document.querySelectorAll(".dropdown").forEach(d=>d.classList.remove("open"));
    load(it.dataset.range);
  });
});
document.querySelector("#exportMenu #exportCsv").addEventListener("click",()=> exportCSV(window.__rows||[]));
document.querySelector("#exportMenu #exportXls").addEventListener("click",()=> exportExcel(window.__rows||[]));
document.querySelector("#exportMenu #exportPdf").addEventListener("click",()=> exportPDF(window.__rows||[]));

/* üî¥ Clear-my-data action */
document.querySelector("#exportMenu #clearData").addEventListener("click", async ()=>{
  document.querySelectorAll(".dropdown").forEach(d=>d.classList.remove("open"));
  if (!token) { alert("No user token in URL. Cannot clear."); return; }

  const ok1 = confirm("Confirm to clear ALL your records? This cannot be undone.");
  if (!ok1) return;
  const ok2 = prompt('Type "CLEAR" to confirm deleting all your entries:');
  if ((ok2 || "").toUpperCase() !== "CLEAR") return;

  try{
    $("status").textContent = "Clearing‚Ä¶";
    const res = await fetch("/api/clear", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ u: token })
    });
    const js = await res.json().catch(()=> ({}));
    if (!res.ok || !js.ok) throw new Error(js.error || "Failed");
    showBubble(`Cleared ${js.countBefore || 0} entries. Fresh start lah ‚ú®`);
    $("status").textContent = "";
    await load();   // refetch & redraw
  }catch(e){
    console.error(e);
    $("status").textContent = "";
    alert("Aiyo, cannot clear now. Try again later.");
  }
});

/* Feedback: open/close + submit */
const fbFab = $("feedbackFab");
const fbPanel = $("feedbackPanel");
const fbText = $("fbText");
const fbSubmit = $("fbSubmit");
const fbStatus = $("fbStatus");

fbFab.addEventListener("click", () => {
  fbPanel.classList.toggle("open");
  if (fbPanel.classList.contains("open")) fbText.focus();
});
document.addEventListener("click", (e)=>{
  if (!fbPanel.contains(e.target) && !fbFab.contains(e.target)) {
    fbPanel.classList.remove("open");
  }
});
document.addEventListener("keydown", (e)=>{
  if (e.key === "Escape") fbPanel.classList.remove("open");
});
fbSubmit.addEventListener("click", async ()=>{
  const msg = fbText.value.trim();
  if (!msg) { fbStatus.textContent = "Write something first üòâ"; return; }
  fbSubmit.disabled = true; fbStatus.textContent = "Sending‚Ä¶";
  const ok = await sendFeedback(msg);
  fbStatus.textContent = ok.server ? "Thanks! Sent to Auntie ‚úÖ" : "Saved locally ‚úÖ";
  fbText.value = "";
  fbSubmit.disabled = false;
  setTimeout(()=>{ fbPanel.classList.remove("open"); fbStatus.textContent=""; }, 1200);
});

/* Try server first, fallback to localStorage */
async function sendFeedback(message){
  try{
    const res = await fetch("/api/feedback", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        u: token || null,
        message,
        page: "summary",
        at: new Date().toISOString()
      })
    });
    if(!res.ok) throw new Error("not ok");
    return { ok:true, server:true };
  }catch(e){
    const key="auntie_feedback_local";
    const list = JSON.parse(localStorage.getItem(key) || "[]");
    list.push({ u: token||null, message, page:"summary", at:new Date().toISOString() });
    localStorage.setItem(key, JSON.stringify(list));
    return { ok:true, server:false };
  }
}

/* main load */
async function load(forceRange){
  const data=await fetchSummary(); if(!data) return;

  $("generatedAt").textContent="Generated at: "+new Date(data.generatedAt||Date.now())
    .toLocaleString("en-SG",{timeZone:SG_TZ,hour12:false});

  const label=$("rangeBtn").textContent.toLowerCase();
  const range = forceRange || (label.includes("month")?"month":label.includes("all")?"all":"week");

  const entries=data.entries||[];
  const now=new Date();
  let scoped=entries;
  if(range==="month"){
    const start=new Date(now.getFullYear(),now.getMonth(),1);
    scoped=entries.filter(e=>new Date(e.date)>=start);
  }else if(range==="week"){
    const day=(now.getDay()+6)%7; const start=new Date(now);
    start.setHours(0,0,0,0); start.setDate(now.getDate()-day);
    scoped=entries.filter(e=>new Date(e.date)>=start);
  }

  const byCat={}; 
  scoped.forEach(e=>{
    const key=(e.category||"uncategorised").trim();
    const amt=Number(e.amount||0);
    byCat[key]=(byCat[key]||0)+amt;
  });
  const rows=Object.entries(byCat).map(([cat,amt])=>[cat, roundToStep(amt)]).sort((a,b)=>b[1]-a[1]);
  const total=rows.reduce((s,[,a])=>s+a,0);
  window.__rows=rows;

  $("kpi-total").textContent=money(total);
  $("kpi-cats").textContent=rows.length;
  $("kpi-entries").textContent=scoped.length;
  $("hdr").textContent=range==="month"?"üßæ This Month Summary":range==="all"?"üßæ All-Time Summary":"üßæ This Week Summary";
  $("kpi-meta").textContent=range==="month"?"This month total":range==="all"?"All-time total":"This week total";

  renderLegend(rows);
  renderTable(rows,total);
  renderRecent(scoped);
  drawDonut($("donut"),rows,total);

  const donut=$("donut"), popup=$("popup");

  const outsideClickHandler = (ev)=>{ if(!donut.contains(ev.target)) { popup.style.display="none"; donutState.lastShownIndex=-1; } };
  document.addEventListener("click", outsideClickHandler, { once:true });

  donut.onclick = (e)=>{
    const rect=donut.getBoundingClientRect();
    const x=e.clientX-rect.left, y=e.clientY-rect.top;
    const cx=rect.width/2, cy=rect.height/2;
    const dx=x-cx, dy=y-cy;
    const r=Math.hypot(dx,dy);

    const inner=donutState.innerR, outer=donutState.outerR;
    if(r<inner || r>outer){ popup.style.display="none"; donutState.lastShownIndex=-1; return; }

    // angle in [0, 2œÄ)
    let ang=Math.atan2(dy,dx);
    if(ang<0) ang+=2*Math.PI;

    // Our segments start at -œÄ/2; map ang to the same frame
    const shift = (ang - (-Math.PI/2) + 2*Math.PI) % (2*Math.PI);

    let hitIndex = -1;
    donutState.sliceAngles.forEach(([s,e],i)=>{
      const start = (s - (-Math.PI/2) + 2*Math.PI) % (2*Math.PI);
      const end   = (e - (-Math.PI/2) + 2*Math.PI) % (2*Math.PI);
      const inside = end>start ? (shift>start && shift<end)
                               : (shift>start || shift<end);
      if(inside) hitIndex=i;
    });

    if (hitIndex === -1) { popup.style.display="none"; donutState.lastShownIndex=-1; return; }

    // Toggle same slice
    if (donutState.lastShownIndex === hitIndex && popup.style.display==="block"){
      popup.style.display="none";
      donutState.lastShownIndex=-1;
      return;
    }

    const [cat,amt]=donutState.rows[hitIndex] || ["‚Äî",0];
    const totalAmt = donutState.rows.reduce((s,[,a])=>s+a,0) || 1;
    popup.style.left=e.pageX+"px";
    popup.style.top=e.pageY+"px";
    popup.innerHTML=`<b>${truncDonut(cat)}</b><br>${money(amt)} (${((amt/totalAmt)*100).toFixed(1)}%)`;
    popup.style.display="block";
    donutState.lastShownIndex=hitIndex;
  };
}

$("refresh").addEventListener("click",()=>{ load(); });
maybeShowOneTimeGreeting();
load();
window.addEventListener("resize",()=>{
  if(window.__rows){
    const total = window.__rows.reduce((s,[,a])=>s+a,0);
    drawDonut($("donut"), window.__rows, total);
  }
});
</script>
</body>
</html>
