<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <title>Auntie Can Count One | Summary</title>

  <!-- Social -->
  <meta property="og:title" content="Auntie Can Count One Summary"/>
  <meta property="og:description" content="Your pastel-fresh spending dashboard: witty Auntie quips + donut chart üí∏"/>
  <meta property="og:image" content="/images/auntie-summary-preview.png"/>
  <meta property="og:url" content="https://auntie-bot.onrender.com/summary.html"/>
  <meta property="og:type" content="website"/>
  <meta name="twitter:card" content="summary_large_image"/>

  <style>
    :root{
      /* Pantone-inspired palette (hex approximations) */
      --desert-flower: #E98C7A;
      --cattleya-orchid: #8E3D79;
      --opera-mauve: #C17BA3;
      --blue-curacao: #58B8C7;
      --spicy-mustard: #D1AE3A;
      --mocha-mousse: #9B6B58;

      /* UI tokens */
      --bg: #FFF9F6;                 /* airy pastel background */
      --ink: #1F2328;                /* high-contrast text */
      --muted: #6B7280;              /* secondary text */
      --card: #FFFFFF;               /* panels */
      --ring: #F0E6DE;               /* borders */
      --radius: 16px;
      --shadow: 0 12px 30px rgba(0,0,0,.06);

      /* Brand accent (gentle coral from Desert Flower) */
      --brand: var(--desert-flower);
      --brand-ink: #7C3E33;

      /* Donut palette rotates these */
      --slice-1: var(--desert-flower);
      --slice-2: var(--blue-curacao);
      --slice-3: var(--opera-mauve);
      --slice-4: var(--spicy-mustard);
      --slice-5: var(--cattleya-orchid);
      --slice-6: var(--mocha-mousse);
      --slice-7: #F5B5A7; /* tints to extend chart colors smoothly */
      --slice-8: #80CDD7;
      --slice-9: #D9A9C5;
      --slice-10:#E4C86A;
    }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color: var(--ink);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(233,140,122,.18), transparent 60%),
        radial-gradient(1000px 500px at 110% 0%, rgba(88,184,199,.15), transparent 60%),
        linear-gradient(#FFFDFC, var(--bg));
    }
    /* Fluid type for comfy mobile/desktop */
    :root{ --step-1: clamp(0.95rem, 0.9rem + 0.4vw, 1.05rem); }

    /* App shell */
    .app{
      max-width: 1100px;
      margin: auto;
      padding: 20px clamp(14px, 3vw, 24px) 40px;
      display: grid; gap: 16px;
    }

    /* Top bar */
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .brand{ display:flex; align-items:center; gap:12px; min-width:0; }
    .logo{
      width:42px;height:42px;border-radius:12px;
      background: radial-gradient(90% 90% at 30% 25%, #FFD8CF 0%, #FFC0B4 45%, var(--desert-flower) 100%);
      display:grid; place-items:center; box-shadow: var(--shadow);
      font-size: 22px;
    }
    h1{ margin:0; font-size: clamp(1.05rem, 0.9rem + 1vw, 1.5rem); color: var(--brand-ink); }
    .sub{ margin:0; color: var(--muted); font-size: var(--step-1); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    /* Controls */
    .controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
    .chip{
      border:1px solid var(--ring); border-radius:999px; padding:8px 12px;
      background:#FFF2EE; color: var(--brand-ink); font-weight:600;
    }
    select,button{
      border:1px solid var(--ring); background:#fff; border-radius:12px;
      padding:10px 12px; font-size: var(--step-1);
    }
    button.primary{
      background: linear-gradient(180deg, #FFE7E1 0%, #FFD9D0 100%);
      border-color:#FFD2C8; font-weight:700; color:#6E362D;
    }
    .meta{ color:var(--muted); font-size:.9rem; }

    /* Panels grid */
    .grid{ display:grid; gap:16px; grid-template-columns: repeat(12, 1fr); }
    .card{
      background: var(--card);
      border: 1px solid var(--ring);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: clamp(14px, 2.2vw, 20px);
    }
    .section-title{ margin:0 0 10px; font-weight:800; letter-spacing:.2px; color:#6E2B20; }

    /* KPI row */
    .kpis{ grid-column: 1 / -1; display:grid; gap:16px; grid-template-columns: repeat(12, 1fr); }
    .kpi{ grid-column: span 4; background: linear-gradient(180deg, #fff, #FFFAF7); border:1px solid var(--ring); border-radius:14px; padding:14px 16px; }
    .kpi h3{ margin:0 0 4px; font-size:.92rem; color: var(--muted); font-weight:700; }
    .value{ font-weight:800; font-size: clamp(1.1rem, 1rem + 1vw, 1.6rem); }
    .value.accent{ color: var(--brand-ink); }

    /* Viz & Breakdown */
    .viz{ grid-column: span 6; display:flex; flex-direction:column; gap:12px; }
    .legend{ display:flex; flex-wrap:wrap; gap:8px; }
    .tag{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:#FFF7F2; border:1px solid var(--ring); font-size:.92rem; }
    .dot{ width:12px; height:12px; border-radius:3px; }

    .breakdown{ grid-column: span 6; }
    .table{ width:100%; border-collapse: collapse; border-radius:12px; overflow:hidden; }
    .table th, .table td{ padding:12px; border-bottom:1px solid #EFE6DD; text-align:left; font-size: var(--step-1); }
    .table th{ background:#FFF3EE; color:#7A5D57; }
    .table tr:last-child td{ border-bottom:none; }
    .amt{ text-align:right; font-variant-numeric: tabular-nums; }
    .pct{ color:var(--muted); font-size:.9rem; text-align:right; }

    .list{ grid-column: 1 / -1; }
    .empty{ color:var(--muted); }
    .quip{ font-weight:700; margin:10px 0 0; }

    /* Responsive: stack nicely on phones */
    @media (max-width: 960px){
      .viz{ grid-column: 1 / -1; }
      .breakdown{ grid-column: 1 / -1; }
    }
    @media (max-width: 740px){
      .topbar{ flex-direction: column; align-items: stretch; gap:10px; }
      .controls{ justify-content: space-between; }
      .sub{ white-space: normal; }
    }
    @media (max-width: 680px){
      .kpi{ grid-column: 1 / -1; }
    }

    /* Reduce motion preference */
    @media (prefers-reduced-motion: reduce){
      *{ animation: none !important; transition: none !important; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Topbar -->
    <div class="topbar">
      <div class="brand">
        <div class="logo">üëµ</div>
        <div>
          <h1>Auntie Can Count One ‚Äî Summary</h1>
          <p class="sub">Pastel Pantone dashboard. Mobile-friendly. Donut so tiny but shiok üç©</p>
        </div>
      </div>
      <div class="controls">
        <span class="chip">View</span>
        <select id="range" aria-label="Summary range">
          <option value="week">This Week</option>
          <option value="month">This Month</option>
          <option value="all">All Time</option>
        </select>
        <button id="refresh" class="primary" aria-label="Refresh summary">Refresh</button>
        <span id="status" class="meta"></span>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpis">
      <div class="kpi">
        <h3 id="hdr">üßæ Summary</h3>
        <div id="kpi-total" class="value accent">S$0.00</div>
        <div id="kpi-meta" class="meta">‚Äî</div>
      </div>
      <div class="kpi">
        <h3>üì¶ Categories</h3>
        <div id="kpi-cats" class="value">0</div>
        <div class="meta">Where your $$ went</div>
      </div>
      <div class="kpi">
        <h3>üóìÔ∏è Entries (range)</h3>
        <div id="kpi-entries" class="value">0</div>
        <div id="kpi-streak" class="meta">‚Äî</div>
      </div>
    </div>

    <!-- Panels -->
    <div class="grid">
      <div class="card viz">
        <div class="section-title">Category Donut</div>
        <!-- Responsive canvas: width 100%; height scales via JS for crispness -->
        <canvas id="donut" aria-label="Spending donut chart" style="width:100%; max-width:640px; height:auto; aspect-ratio: 13/8;"></canvas>
        <div id="legend" class="legend" aria-label="Legend"></div>
      </div>

      <div class="card breakdown">
        <div class="section-title">Breakdown</div>
        <table class="table" aria-label="Category breakdown table">
          <thead>
            <tr><th>Category</th><th class="amt">Amount</th><th class="pct">Share</th></tr>
          </thead>
          <tbody id="tbl"></tbody>
        </table>
        <p id="quip" class="quip" hidden></p>
      </div>

      <div class="card list">
        <div class="section-title">Recent Entries</div>
        <table class="table" aria-label="Recent entries">
          <thead>
            <tr><th>#</th><th>When (SGT)</th><th>Category</th><th class="amt">Amount</th></tr>
          </thead>
          <tbody id="recent"></tbody>
        </table>
        <p id="empty" class="empty" hidden>No records yet lah üòÖ</p>
        <p id="error" class="empty" hidden>Cannot load summary üò¢</p>
      </div>
    </div>

    <div class="meta" id="generatedAt"></div>
  </div>

<script>
/* ========= Helpers & Constants ========= */
const SG_TZ = "Asia/Singapore";
const params = new URLSearchParams(location.search);
const token = params.get("u");

const $ = id => document.getElementById(id);
const show = (id, on) => ($(id).hidden = !on);
const toSG = d => new Date(new Date(d).toLocaleString("en-SG", { timeZone: SG_TZ }));
const startOfWeek = (d=new Date()) => { const sg=toSG(d); const day=(sg.getDay()+6)%7; sg.setHours(0,0,0,0); sg.setDate(sg.getDate()-day); return sg; };
const startOfMonth = (d=new Date()) => { const sg=toSG(d); sg.setHours(0,0,0,0); sg.setDate(1); return sg; };
const within = (iso, from, to) => { const t=new Date(iso); return t>=from && t<=to; };
const money = n => "S$" + Number(n).toFixed(2);
const esc = s => String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const rand = a => a[Math.floor(Math.random()*a.length)];

/* Witty packs */
const WEEK_HEADERS = ["üßæ This Week Summary","üßæ Weekly Rundown","üßæ Your Week in Dollars","üßæ Auntie‚Äôs Weekly Report","üßæ Weekly Wallet Story","üßæ This Week Damage","üßæ Week Spend Chart","üßæ Weekly Tally","üßæ Week at a Glance","üßæ Weekly Checkout","üßæ Pocket Diary (Week)","üßæ Week Summary Can One","üßæ This Week‚Äôs Kopi Count","üßæ Week Spend Breakdown","üßæ Weekly Finance Gossip","üßæ Short Week Recap","üßæ Weekly Budget Pulse","üßæ Your Week, Your $","üßæ Week: Where Money Went","üßæ Auntie‚Äôs Week Audit"];
const MONTH_HEADERS= ["üßæ This Month Summary","üßæ Monthly Rundown","üßæ Your Month in Dollars","üßæ Auntie‚Äôs Monthly Report","üßæ Monthly Wallet Story","üßæ This Month Damage","üßæ Month Spend Chart","üßæ Monthly Tally","üßæ Month at a Glance","üßæ Monthly Checkout","üßæ Pocket Diary (Month)","üßæ Month Summary Can One","üßæ This Month‚Äôs Kopi Count","üßæ Month Spend Breakdown","üßæ Monthly Finance Gossip","üßæ Long Month Recap","üßæ Monthly Budget Pulse","üßæ Your Month, Your $","üßæ Month: Where Money Went","üßæ Auntie‚Äôs Month Audit"];
const FOOTERS = ["Steady lah, watch your spending üí™","Little by little become mountain üèîÔ∏è","Budget got eyes one ‚Äî good job üëÄ","Track now, enjoy later üéØ","Discipline today, freedom tomorrow üöÄ","Wallet say thank you üôè","You + Auntie = Power duo ‚ö°","Your future self clap for you üëè","Don‚Äôt let promo code control you üòú","Treat yourself, but treat savings also üê∑","Clean like kopi-o kosong ‚òï","You‚Äôre the CFO of your life üß†","Kiasu with money is good kind üëç","Wallet doing push-ups now üèãÔ∏è","Huat slowly but surely üßß","From cents to sense üß©","Auntie proud of you ü•π","Bao jiak plan ‚Äî continue like this üç±","Nice lah, consistent like MRT timing (usually) üöà","Power discipline, power future ‚ö°"];
const SPICE_TODAY = ["Today you very hardworking tracking ah üëç","Wah, today your expense diary on fire üî•","Steady lah ‚Äî consistent logging is power ‚ö°","Auntie clap for your discipline üëè","Today you and Auntie best friends already ü§ù","Budget streak unlocked üèÖ","Your future self say thank you üôè","Solid logging ‚Äî CFO material üß†","Sibei on ‚Äî keep going üí™","Tracking champion of the day üèÜ"];
const SPICE_HIGH  = ["Auntie‚Äôs eyebrow raise a bit ü´£ ‚Äî careful ah.","Big spender vibes today ‚Äî balance balance ya ‚öñÔ∏è","Wallet say, ‚Äúeh bro‚Ä¶‚Äù üòÇ ‚Äî but still on track.","Treat yo‚Äô self accepted, save yo‚Äô self tomorrow ‚ú®","Budget warning light blinking a bit üö® ‚Äî steady.","High SES energy detected ‚ú® ‚Äî remember drink water üíß","Oof, heart pain a bit ‚Äî but you‚Äôre tracking, good! üß†","Legendary purchase unlocked üèÜ ‚Äî next one cheap cheap?","Wallet doing HIIT today üèãÔ∏è ‚Äî breathe.","Shopee/Lazada pause one minute can? üòÖ"];

/* Donut colors from CSS vars */
const donutPalette = [
  getCSS('--slice-1'),getCSS('--slice-2'),getCSS('--slice-3'),getCSS('--slice-4'),getCSS('--slice-5'),
  getCSS('--slice-6'),getCSS('--slice-7'),getCSS('--slice-8'),getCSS('--slice-9'),getCSS('--slice-10'),
];
function getCSS(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

/* ========= Data Flow ========= */
async function fetchSummary(){
  if(!token){ $("status").textContent="No token found lah üòÖ"; return null; }
  try{
    $("status").textContent="Fetching‚Ä¶";
    const res = await fetch(`/api/summary?u=${encodeURIComponent(token)}&_=${Date.now()}`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    $("status").textContent="";
    return data;
  }catch(e){
    console.error(e); $("status").textContent=""; show("error", true); return null;
  }
}

function filterByRange(entries, range){
  const now=new Date();
  if(range==="all") return entries;
  if(range==="month") return entries.filter(e=>within(e.date, startOfMonth(now), now));
  return entries.filter(e=>within(e.date, startOfWeek(now), now)); // week
}
function computeTodayCount(entries){
  const s=toSG(new Date()); s.setHours(0,0,0,0);
  const e=toSG(new Date()); e.setHours(23,59,59,999);
  return entries.filter(x=>within(x.date,s,e)).length;
}
function aggregate(entries){
  const byCat = {}; let total = 0;
  for(const e of entries){
    const cat=(e.category||"uncategorised");
    const amt=Number(e.amount||0);
    byCat[cat]=(byCat[cat]||0)+amt; total+=amt;
  }
  return { rows: Object.entries(byCat).sort((a,b)=>b[1]-a[1]), total };
}

/* ========= Donut (responsive, vanilla canvas) ========= */
function sizeCanvasForDisplay(canvas){
  const ratio = window.devicePixelRatio || 1;
  const cssW = canvas.clientWidth;
  const cssH = canvas.clientHeight;
  canvas.width  = Math.max(300, Math.floor(cssW * ratio));
  canvas.height = Math.max(200, Math.floor(cssH * ratio));
  const ctx = canvas.getContext('2d');
  ctx.setTransform(ratio,0,0,ratio,0,0); // scale drawing to look crisp
  return ctx;
}
function drawDonut(canvas, rows, total){
  const ctx = sizeCanvasForDisplay(canvas);
  const W = canvas.clientWidth, H = canvas.clientHeight;
  ctx.clearRect(0,0,W,H);

  const cx = W/2, cy = H/2;
  const outerR = Math.min(W,H)*0.42;
  const innerR = outerR*0.60;

  let start = -Math.PI/2;
  rows.forEach(([cat, amt], i)=>{
    const frac = total ? amt/total : 0;
    const angle = frac * Math.PI*2;
    const end = start + angle;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, outerR, start, end);
    ctx.lineTo(cx, cy);
    ctx.fillStyle = donutPalette[i % donutPalette.length];
    ctx.fill();
    start = end;
  });

  // hole
  ctx.globalCompositeOperation = "destination-out";
  ctx.beginPath(); ctx.arc(cx, cy, innerR, 0, Math.PI*2); ctx.fill();
  ctx.globalCompositeOperation = "source-over";

  // center label
  ctx.fillStyle = "#5B3B33";
  ctx.textAlign = "center";
  ctx.font = "700 14px ui-sans-serif,system-ui";
  ctx.fillText("Total", cx, cy-10);
  ctx.font = "800 20px ui-sans-serif,system-ui";
  ctx.fillText(money(total), cx, cy+16);
}

/* ========= Render UI ========= */
function renderLegend(rows){
  const legend = $("legend");
  legend.innerHTML = "";
  rows.forEach(([cat], i)=>{
    const tag = document.createElement("div");
    tag.className = "tag";
    const dot = document.createElement("span");
    dot.className = "dot";
    dot.style.background = donutPalette[i % donutPalette.length];
    const label = document.createElement("span");
    label.textContent = cat;
    tag.append(dot, label);
    legend.appendChild(tag);
  });
}
function renderTable(rows, total){
  const tbody = $("tbl"); tbody.innerHTML = "";
  rows.forEach(([cat, amt], i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><span style="display:inline-flex;align-items:center;gap:8px">
        <span style="width:10px;height:10px;border-radius:3px;background:${donutPalette[i%donutPalette.length]}"></span>
        ${esc(cat)}
      </span></td>
      <td class="amt">${money(amt)}</td>
      <td class="pct">${total ? (amt/total*100).toFixed(1)+"%" : "‚Äî"}</td>`;
    tbody.appendChild(tr);
  });
}
function renderRecent(entries){
  const recent = [...entries].slice(-10).reverse();
  const tbody = $("recent"); tbody.innerHTML = "";
  if(!recent.length){ show("empty", true); return; }
  show("empty", false);
  recent.forEach((e, idx)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td>${new Date(e.date).toLocaleString("en-SG",{timeZone:SG_TZ, hour12:false})}</td>
      <td>${esc(e.category || "uncategorised")}</td>
      <td class="amt">${money(e.amount||0)}</td>`;
    tbody.appendChild(tr);
  });
}
function renderQuips(allEntries, scopedTotal){
  const chunks = [];
  if (computeTodayCount(allEntries) >= 3) chunks.push(rand(SPICE_TODAY));
  if (scopedTotal >= 200) chunks.push(rand(SPICE_HIGH));
  chunks.push(rand(FOOTERS));
  $("quip").textContent = chunks.join("  ‚Ä¢  ");
  show("quip", true);
}
function renderKpis(range, rows, total, entries){
  const hdr = range==="month" ? rand(MONTH_HEADERS)
            : range==="week"  ? rand(WEEK_HEADERS)
            : "üßæ All-Time Summary";
  $("hdr").textContent = hdr;
  $("kpi-total").textContent = money(total);
  $("kpi-cats").textContent = rows.length;
  $("kpi-entries").textContent = entries.length;
  $("kpi-meta").textContent = range==="month" ? "This month total" : range==="week" ? "This week total" : "All-time total";
  const today = computeTodayCount(entries);
  $("kpi-streak").textContent = today>=3 ? "Busy day logging üìà" : today>0 ? "Nice, added today üëç" : "No entries yet today";
}

/* ========= Controller ========= */
let _rawData = null;
async function load(){
  const data = _rawData ||= await fetchSummary();
  if (!data) return;

  $("generatedAt").textContent = "Generated at: " + new Date(data.generatedAt||Date.now()).toLocaleString("en-SG",{timeZone:SG_TZ, hour12:false});

  const range = $("range").value;
  const scoped = filterByRange(data.entries, range);
  // Update instantly on range change (no refetch)
  if(!scoped.length){
    $("tbl").innerHTML = ""; $("legend").innerHTML = "";
    const ctx = $("donut").getContext("2d"); ctx.clearRect(0,0,$("donut").width,$("donut").height);
    show("empty", true);
    $("kpi-total").textContent = "S$0.00";
    $("kpi-cats").textContent = "0";
    $("kpi-entries").textContent = "0";
    $("kpi-meta").textContent = range==="month" ? "This month total" : range==="week" ? "This week total" : "All-time total";
    $("hdr").textContent = range==="month" ? rand(MONTH_HEADERS) : range==="week" ? rand(WEEK_HEADERS) : "üßæ All-Time Summary";
    show("quip", false);
    return;
  }
  show("empty", false);

  const { rows, total } = aggregate(scoped);
  renderKpis(range, rows, total, scoped);
  renderLegend(rows);
  renderTable(rows, total);
  renderRecent(scoped);
  drawDonut($("donut"), rows, total);
  renderQuips(data.entries, total);
}

/* Events & Resize handling */
$("refresh").addEventListener("click", async () => { _rawData = null; await load(); });
$("range").addEventListener("change", load);
window.addEventListener("resize", () => { if(_rawData){ const range=$("range").value; const scoped=filterByRange(_rawData.entries, range); const { rows, total } = aggregate(scoped); drawDonut($("donut"), rows, total); }});

load();
</script>
</body>
</html>
