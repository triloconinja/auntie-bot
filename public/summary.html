<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Auntie Can Count One | Summary</title>

<style>
:root{
  --desert-flower:#E98C7A;
  --blue-curacao:#58B8C7;
  --opera-mauve:#C17BA3;
  --spicy-mustard:#D1AE3A;
  --mocha-mousse:#9B6B58;
  --cattleya-orchid:#8E3D79;
  --bg:#FFF9F6;
  --ink:#1F2328;
  --muted:#6B7280;
  --ring:#F0E6DE;
  --shadow:0 12px 30px rgba(0,0,0,.06);
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:ui-sans-serif,system-ui,"Segoe UI",Roboto;
  color:var(--ink);
  background:
    radial-gradient(1200px 600px at 10% -10%, rgba(233,140,122,.18), transparent 60%),
    radial-gradient(1000px 500px at 110% 0%, rgba(88,184,199,.15), transparent 60%),
    linear-gradient(#FFFDFC,var(--bg));
  overflow-x:hidden;
}
.app{max-width:1100px;margin:auto;padding:20px clamp(14px,3vw,24px) 40px;display:grid;gap:16px;}
.topbar{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;}
.brand{display:flex;align-items:center;gap:12px;}
.logo{
  width:48px;height:48px;border-radius:50%;
  background:linear-gradient(145deg,var(--desert-flower),var(--blue-curacao));
  display:flex;align-items:center;justify-content:center;
  box-shadow:var(--shadow);
}
.logo svg{width:32px;height:32px;}
h1{margin:0;font-size:clamp(1.1rem,1vw+1rem,1.5rem);color:var(--mocha-mousse);}
.sub{margin:0;color:var(--muted);font-size:.95rem;}
.controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.dropdown{position:relative;}
.dropdown-btn{
  background:linear-gradient(180deg,#FDF7F5 0%,#FCEFEA 100%);
  border:1px solid var(--ring);border-radius:12px;
  padding:10px 14px;font-weight:600;color:var(--ink);
  cursor:pointer;display:flex;align-items:center;gap:6px;transition:border-color .2s;
}
.dropdown-btn:hover{border-color:var(--blue-curacao);}
.dropdown-menu{
  position:absolute;top:110%;left:0;background:#fff;
  border:1px solid var(--ring);border-radius:12px;
  box-shadow:0 6px 20px rgba(0,0,0,.08);
  min-width:160px;padding:6px 0;
  opacity:0;pointer-events:none;
  transform:translateY(8px);
  transition:opacity .25s ease,transform .25s ease;
  z-index:100;
}
.dropdown.open .dropdown-menu{opacity:1;pointer-events:auto;transform:translateY(0);}
.dropdown-item{
  padding:10px 14px;display:flex;align-items:center;gap:8px;
  color:var(--ink);font-size:.95rem;cursor:pointer;transition:background .15s;
}
.dropdown-item:hover{background:linear-gradient(90deg,#E8FAFC,#fff);}
button.primary{
  background:linear-gradient(180deg,#FFE7E1 0%,#FFD9D0 100%);
  border:1px solid #FFD2C8;border-radius:12px;
  padding:10px 14px;font-weight:700;color:#6E362D;cursor:pointer;
}
.meta{color:var(--muted);font-size:.9rem;}
/* Panels */
.kpis{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));}
.kpi{background:linear-gradient(to bottom right,#fff,var(--desert-flower, #fdd));border:1px solid var(--ring);border-radius:16px;box-shadow:var(--shadow);padding:16px;}
.kpi h3{margin-bottom:4px;font-size:.9rem;color:var(--muted);}
.value{font-weight:800;font-size:1.4rem;color:var(--ink);}
.grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));}
.card{border-radius:16px;box-shadow:var(--shadow);padding:20px;}
.viz{background:linear-gradient(to bottom right,#fff,var(--blue-curacao));}
.breakdown{background:linear-gradient(to bottom right,#fff,var(--opera-mauve));}
.list{background:linear-gradient(to bottom right,#fff,var(--spicy-mustard));}
.section-title{margin-bottom:10px;font-weight:800;color:#6E2B20;}
.table{width:100%;border-collapse:collapse;}
.table th,.table td{padding:12px;border-bottom:1px solid #EFE6DD;text-align:left;font-size:.95rem;}
.table th{background:#FFF3EE;color:#7A5D57;}
.amt{text-align:right;}
.pct{color:var(--muted);font-size:.9rem;text-align:right;}
.legend{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;}
.tag{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#FFF7F2;border:1px solid var(--ring);font-size:.9rem;}
.dot{width:12px;height:12px;border-radius:3px;}
#popup{position:absolute;display:none;pointer-events:none;background:#fff;border:1px solid var(--ring);border-radius:8px;padding:6px 10px;box-shadow:var(--shadow);font-size:.85rem;color:#333;z-index:999;}
#auntie-bubble{position:fixed;bottom:16px;right:16px;max-width:260px;background:linear-gradient(to bottom right,#fff,var(--cattleya-orchid));border:1px solid var(--ring);border-radius:16px;padding:12px 14px;box-shadow:var(--shadow);font-size:.9rem;color:#6E2B20;display:none;animation:fadeIn .4s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
@media(max-width:768px){
  canvas{width:100%!important;height:auto!important;}
}
</style>
</head>

<body>
<div class="app">
  <div class="topbar">
    <div class="brand">
      <div class="logo">
        <!-- pastel Auntie SVG -->
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="28" fill="none" stroke="#222" stroke-width="2"/><path d="M22 38c5 6 15 6 20 0" stroke="#222" stroke-width="2" fill="none"/><circle cx="24" cy="26" r="3" fill="#222"/><circle cx="40" cy="26" r="3" fill="#222"/><path d="M28 18c2-4 8-4 10 0" stroke="#222" stroke-width="2" fill="none"/></svg>
      </div>
      <div>
        <h1>Auntie Can Count One ‚Äî Summary</h1>
        <p class="sub">Pastel Pantone dashboard. Donut so tiny but shiok üç©</p>
      </div>
    </div>

    <div class="controls">
      <div class="dropdown" id="rangeDrop">
        <div class="dropdown-btn" id="rangeBtn">This Week ‚ñæ</div>
        <div class="dropdown-menu" id="rangeMenu">
          <div class="dropdown-item" data-range="week">This Week</div>
          <div class="dropdown-item" data-range="month">This Month</div>
          <div class="dropdown-item" data-range="all">All Time</div>
        </div>
      </div>

      <div class="dropdown" id="exportDrop">
        <div class="dropdown-btn" id="exportBtn">Export ‚ñæ</div>
        <div class="dropdown-menu" id="exportMenu">
          <div class="dropdown-item" id="exportCsv">üìÑ CSV</div>
          <div class="dropdown-item" id="exportXls">üìä Excel</div>
          <div class="dropdown-item" id="exportPdf">üñ®Ô∏è PDF</div>
        </div>
      </div>

      <button id="refresh" class="primary">Refresh</button>
      <span id="status" class="meta"></span>
    </div>
  </div>

  <div class="kpis">
    <div class="kpi"><h3 id="hdr">üßæ Summary</h3><div id="kpi-total" class="value">S$0.00</div><div id="kpi-meta" class="meta">‚Äî</div></div>
    <div class="kpi"><h3>üì¶ Categories</h3><div id="kpi-cats" class="value">0</div></div>
    <div class="kpi"><h3>üóìÔ∏è Entries</h3><div id="kpi-entries" class="value">0</div></div>
  </div>

  <div class="grid">
    <div class="card viz">
      <div class="section-title">Category Donut</div>
      <canvas id="donut"></canvas>
      <div id="legend" class="legend"></div>
    </div>

    <div class="card breakdown">
      <div class="section-title">Breakdown</div>
      <table class="table"><thead><tr><th>Category</th><th class="amt">Amount</th><th class="pct">Share</th></tr></thead><tbody id="tbl"></tbody></table>
    </div>

    <div class="card list">
      <div class="section-title">Recent Entries</div>
      <table class="table"><thead><tr><th>#</th><th>When (SGT)</th><th>Category</th><th class="amt">Amount</th></tr></thead><tbody id="recent"></tbody></table>
      <p id="empty" class="meta" hidden>No records yet lah üòÖ</p>
    </div>
  </div>

  <div class="meta" id="generatedAt"></div>
</div>

<div id="popup"></div>
<div id="auntie-bubble"></div>

<script>
const SG_TZ="Asia/Singapore";
const token=new URLSearchParams(location.search).get("u");
const $=id=>document.getElementById(id);
const money=n=>"S$"+Number(n).toFixed(2);
const rand=a=>a[Math.floor(Math.random()*a.length)];
const SINGLISH_QUOTES=[
"Steady lah üí™ you power one!",
"Aiyo üòÖ spend again ah?",
"Huat ah üßß but don‚Äôt overspend hor!",
"Wallet say ü•≤ 'help me please!'",
"Budget tight like jeans sia üëñ",
"Don‚Äôt act blur hor üëÄ every dollar count!",
"Good job sia üëç discipline!",
"Buy kopi or caf√© sia ‚òï",
"Auntie proud lah ü•π",
"Small small also count one üí∞",
"Don‚Äôt say Auntie never remind ah ü§®",
"Steady like MRT timing (sometimes) üöà",
"Save first then shop lah üõçÔ∏è",
"You can lah üí™ continue!",
"Kopi again? ‚òï Wallet shaking leh!",
"Auntie clap for you üëè",
"Today save, tomorrow huat üåà",
"Don‚Äôt blur blur lah üòÖ",
"Wah high SES today ah ‚ú®",
"Spend liao must log ok ‚úÖ",
"Keep going! Power discipline ‚ö°",
"Budget hero sia ü¶∏‚Äç‚ôÇÔ∏è",
"Auntie say good job üëç",
"Wah spend like minister ah üíº",
"Don‚Äôt later cry hor üò≠",
"Auntie eyes big big üëÄ checking your spending",
"Steady lah you üßæ",
"Save today, smile tomorrow üòÑ",
"Money no grow on tree leh üå≥",
"Control a bit lah üòÜ",
"Reward yourself, but small small ok üéÅ",
"Good boy/girl lah üëè saving like pro!",
"Spend wisely hor üí∏",
"Budget got eyes one üëÄ",
"Jialat! Too much spend! üòÇ",
"Auntie approve this one ‚úÖ",
"Wah sibei consistent sia üî•",
"Don‚Äôt forget kopi money ‚òï",
"Your wallet got six-pack already üèãÔ∏è‚Äç‚ôÄÔ∏è",
"Today eat big, tomorrow Maggie mee ah üçú",
"Aiyo Auntie faint already üòµ‚Äçüí´",
"Money fly faster than MRT üõ´",
"Smart spender lah üí°",
"Save more can buy Tesla üöó",
"Your future self say thank you üôè",
"Huat slowly but surely üßß",
"Auntie say continue like this good lah üíÖ",
"Don‚Äôt forget your budget friend hor üíÅ‚Äç‚ôÄÔ∏è",
"Last warning, control spending ok üò§",
"Solid lah, CFO material üß†",
"Budget so tight can hear squeak üê≠",
"Ok lah, at least you tracking üëå"
];
function showBubble(msg){const b=$("auntie-bubble");b.textContent=msg;b.style.display="block";setTimeout(()=>b.style.display="none",6000);}
async function fetchSummary(){
 if(!token){$("status").textContent="No token found lah üòÖ";return null;}
 try{$("status").textContent="Fetching‚Ä¶";const r=await fetch(`/api/summary?u=${encodeURIComponent(token)}&_=${Date.now()}`);
 if(!r.ok)throw new Error(`HTTP ${r.status}`);const d=await r.json();$("status").textContent="";return d;}
 catch(e){console.error(e);$("status").textContent="Error üò¢";return null;}
}
function sizeCanvasForDisplay(c){const ratio=window.devicePixelRatio||1;const cssW=c.clientWidth;const cssH=c.clientHeight;c.width=Math.floor(cssW*ratio);c.height=Math.floor(cssH*ratio);const ctx=c.getContext("2d");ctx.setTransform(ratio,0,0,ratio,0,0);return ctx;}
const donutPalette=["#E98C7A","#58B8C7","#C17BA3","#8E3D79","#D1AE3A","#9B6B58"];
function drawDonut(c,rows,total){
 const ctx=sizeCanvasForDisplay(c);const W=c.clientWidth,H=c.clientHeight;ctx.clearRect(0,0,W,H);
 const cx=W/2,cy=H/2;const outerR=Math.min(W,H)*0.42,innerR=outerR*0.6;
 let start=-Math.PI/2;
 rows.forEach(([cat,amt],i)=>{const frac=total?amt/total:0;const angle=frac*Math.PI*2;const end=start+angle;
 ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,outerR,start,end);ctx.lineTo(cx,cy);
 ctx.fillStyle=donutPalette[i%donutPalette.length];ctx.fill();rows[i].angle=[start,end];start=end;});
 ctx.globalCompositeOperation="destination-out";ctx.beginPath();ctx.arc(cx,cy,innerR,0,Math.PI*2);ctx.fill();ctx.globalCompositeOperation="source-over";
 ctx.fillStyle="#5B3B33";ctx.textAlign="center";ctx.font="700 14px sans-serif";ctx.fillText("Total",cx,cy-10);ctx.font="800 20px sans-serif";ctx.fillText(money(total),cx,cy+16);
}
function renderLegend(rows){const legend=$("legend");legend.innerHTML="";rows.forEach(([cat],i)=>{const tag=document.createElement("div");tag.className="tag";const dot=document.createElement("span");dot.className="dot";dot.style.background=donutPalette[i%donutPalette.length];const label=document.createElement("span");label.textContent=cat;tag.append(dot,label);legend.appendChild(tag);});}
function renderTable(rows,total){const tbody=$("tbl");tbody.innerHTML="";rows.forEach(([cat,amt],i)=>{const tr=document.createElement("tr");tr.innerHTML=`<td><span style='display:inline-flex;align-items:center;gap:8px'><span style='width:10px;height:10px;border-radius:3px;background:${donutPalette[i%donutPalette.length]}'></span>${cat}</span></td><td class='amt'>${money(amt)}</td><td class='pct'>${total?(amt/total*100).toFixed(1)+'%':'‚Äî'}</td>`;tbody.appendChild(tr);});}
function renderRecent(entries){const tbody=$("recent");tbody.innerHTML="";if(!entries.length){$("empty").hidden=false;return;}$("empty").hidden=true;entries.slice(-10).reverse().forEach((e,i)=>{const tr=document.createElement("tr");tr.innerHTML=`<td>${i+1}</td><td>${new Date(e.date).toLocaleString("en-SG",{timeZone:SG_TZ,hour12:false})}</td><td>${e.category||'uncategorised'}</td><td class='amt'>${money(e.amount||0)}</td>`;tbody.appendChild(tr);});}
function exportCSV(rows){const d=new Date().toISOString().slice(0,10);let csv="Category,Amount\n";rows.forEach(([c,a])=>csv+=`${c},${a}\n`);const b=new Blob([csv],{type:"text/csv"});const url=URL.createObjectURL(b);const a=document.createElement("a");a.href=url;a.download=`auntie_summary_${d}.csv`;a.click();}
async function load(){
 const data=await fetchSummary();if(!data)return;
 const range=$("rangeBtn").textContent.toLowerCase().includes("month")?"month":$("rangeBtn").textContent.toLowerCase().includes("all")?"all":"week";
 const entries=data.entries||[];let filtered=entries;
 const now=new Date();if(range==="month"){const start=new Date(now.getFullYear(),now.getMonth(),1);filtered=entries.filter(e=>new Date(e.date)>=start);}else if(range==="week"){const day=(now.getDay()+6)%7;const start=new Date(now);start.setDate(now.getDate()-day);filtered=entries.filter(e=>new Date(e.date)>=start);}
 const byCat={};let total=0;for(const e of filtered){const cat=e.category||"uncategorised";const amt=+e.amount||0;byCat[cat]=(byCat[cat]||0)+amt;total+=amt;}
 const rows=Object.entries(byCat).sort((a,b)=>b[1]-a[1]);
 renderLegend(rows);renderTable(rows,total);renderRecent(filtered);drawDonut($("donut"),rows,total);
 $("kpi-total").textContent=money(total);$("kpi-cats").textContent=rows.length;$("kpi-entries").textContent=filtered.length;
 $("generatedAt").textContent="Generated at: "+new Date().toLocaleString("en-SG",{timeZone:SG_TZ});
 showBubble(rand(SINGLISH_QUOTES));
}
document.querySelectorAll(".dropdown-btn").forEach(btn=>btn.addEventListener("click",e=>{const d=btn.parentElement;d.classList.toggle("open");document.querySelectorAll(".dropdown").forEach(o=>{if(o!==d)o.classList.remove("open");});}));
document.addEventListener("click",e=>{if(!e.target.closest(".dropdown"))document.querySelectorAll(".dropdown").forEach(d=>d.classList.remove("open"));});
document.querySelectorAll("#rangeMenu .dropdown-item").forEach(it=>it.addEventListener("click",e=>{$("rangeBtn").textContent=e.target.textContent+" ‚ñæ";document.querySelectorAll(".dropdown").forEach(d=>d.classList.remove("open"));load();}));
document.querySelectorAll("#exportMenu .dropdown-item").forEach(it=>it.addEventListener("click",()=>{showBubble(rand(SINGLISH_QUOTES));}));
$("refresh").addEventListener("click",()=>{load();showBubble(rand(SINGLISH_QUOTES));});
window.addEventListener("resize",()=>{load();});
load();
</script>
</body>
</html>
